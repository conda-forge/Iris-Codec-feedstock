#!/bin/bash

mkdir build && cd  build

CXXFLAGS="${CXXFLAGS} -D_LIBCPP_DISABLE_AVAILABILITY"

cmake ${CMAKE_ARGS} -D CMAKE_INSTALL_PREFIX=$PREFIX \
      -D CMAKE_INSTALL_LIBDIR=$PREFIX/lib \
      -D CMAKE_INSTALL_PYTHON_LIBDIR=$SP_DIR \
      -D IRIS_BUILD_SHARED=ON \
      -D IRIS_BUILD_STATIC=OFF \
      -D IRIS_BUILD_ENCODER=ON \
      -D IRIS_BUILD_DEPENDENCIES=OFF \
      -D IRIS_BUILD_PYTHON=ON \
      -D CMAKE_BUILD_TYPE=Release \
      $SRC_DIR

cmake --build . --config Release -j$CPU_COUNT

cmake --install .

# Skip ``ctest`` when cross-compiling
if [[ "${CONDA_BUILD_CROSS_COMPILATION:-}" != "1" || "${CROSSCOMPILING_EMULATOR:-}" != "" ]]; then
  ctest
fi